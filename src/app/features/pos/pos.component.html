<div class="min-h-screen bg-gray-50 overflow-auto pb-24 md:pb-4">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Mensaje de Alerta -->
    @if (mensajeAlerta()) {
    <div
      class="mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded animate-pulse"
    >
      <p class="text-sm font-semibold">{{ mensajeAlerta() }}</p>
    </div>
    }

    <!-- Grid principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- ============================= -->
      <!-- PRODUCTOS (2/3 en desktop) -->
      <!-- ============================= -->
      <div class="lg:col-span-2 bg-white rounded-lg shadow-sm p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <span class="text-2xl">üõí</span>
            <span>Productos ({{ totalProductos() }})</span>
          </h2>

          <button
            (click)="limpiarFiltros()"
            class="text-sm text-red-600 hover:text-red-800 font-semibold"
          >
            üóëÔ∏è Limpiar filtros
          </button>
        </div>

        <!-- ‚úÖ NUEVO: Filtros de Categor√≠a -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            üìÇ Categor√≠as
          </label>
          <div class="flex gap-2 flex-wrap">
            @for (cat of CATEGORIAS; track cat.valor) {
            <button
              (click)="cambiarCategoria(cat.valor)"
              [class.bg-blue-600]="categoriaSeleccionada() === cat.valor"
              [class.text-white]="categoriaSeleccionada() === cat.valor"
              [class.bg-gray-100]="categoriaSeleccionada() !== cat.valor"
              [class.text-gray-700]="categoriaSeleccionada() !== cat.valor"
              class="px-3 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-1"
            >
              <span>{{ cat.emoji }}</span>
              <span>{{ cat.etiqueta }}</span>
            </button>
            }
          </div>
        </div>

        <!-- üîç Buscador -->
        <div class="mb-4 relative">
          <input
            type="text"
            [value]="terminoBusqueda()"
            (input)="actualizarBusqueda($event)"
            placeholder="Buscar por nombre o c√≥digo de barras..."
            class="w-full px-4 py-3 pl-12 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
          />
          <span
            class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"
          >
            üîç
          </span>

          @if (terminoBusqueda()) {
          <button
            (click)="limpiarBusqueda()"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 font-bold"
          >
            ‚úï
          </button>
          }
        </div>

        <!-- Loading State -->
        @if (loading()) {
        <div class="text-center py-12">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"
          ></div>
          <p class="text-gray-600 mt-4">Cargando productos...</p>
        </div>
        }

        <!-- Error State -->
        @else if (error()) {
        <div class="text-center py-12">
          <div class="text-red-600 text-5xl mb-4">‚ö†Ô∏è</div>
          <p class="text-red-600 text-lg font-semibold">{{ error() }}</p>
          <button
            (click)="recargarProductos()"
            class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
          >
            Reintentar
          </button>
        </div>
        }

        <!-- Empty State -->
        @else if (productos().length === 0) {
        <div class="text-center py-12 text-gray-500">
          <div class="text-5xl mb-4">üì≠</div>
          <p class="text-lg font-semibold">No se encontraron productos</p>
          @if (terminoBusqueda() || categoriaSeleccionada() !== 'todas') {
          <p class="text-sm mt-2">Intenta ajustar los filtros de b√∫squeda</p>
          } @else {
          <p class="text-sm mt-2">Agrega productos desde el inventario</p>
          }
        </div>
        }

        <!-- Grid de Productos -->
        @else {
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          @for (producto of productos(); track producto._id) {
          <button
            (click)="agregarAlCarrito(producto)"
            class="bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-400 rounded-lg p-3 text-left transition-all relative"
            [disabled]="!puedeAgregarMas(producto)"
            [class.opacity-50]="!puedeAgregarMas(producto)"
            [class.cursor-not-allowed]="!puedeAgregarMas(producto)"
          >
            @if (obtenerCantidadEnCarrito(producto._id) > 0) {
            <span
              class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center shadow-md z-10"
            >
              {{ obtenerCantidadEnCarrito(producto._id) }}
            </span>
            }

            <div class="text-sm font-semibold text-gray-800 mb-1 truncate">
              {{ producto.nombre }}
            </div>

            <div class="text-lg font-bold text-green-600 mb-2">
              ${{ producto.precioVenta.toLocaleString("es-MX") }}
            </div>

            <div class="text-xs mt-2 space-y-1">
              @if (producto.stock === 0) {
              <div class="flex items-center gap-1 text-red-600 font-semibold">
                <span>‚ùå</span>
                <span>Sin stock</span>
              </div>
              } @else if (producto.stock < producto.stockMinimo) {
              <div
                class="flex items-center gap-1 text-yellow-600 font-semibold"
              >
                <span>‚ö†Ô∏è</span>
                <span>Stock: {{ producto.stock }}</span>
              </div>
              } @else {
              <div class="flex items-center gap-1 text-gray-600">
                <span>‚úÖ</span>
                <span>Stock: {{ producto.stock }}</span>
              </div>
              }
            </div>
          </button>
          }
        </div>

        <!-- ‚úÖ MEJORADA: Paginaci√≥n estilo componente ventas -->
        @if (totalProductos() > 0) {
        <div class="mt-6 pt-4 border-t">
          <!-- Texto informativo (oculto en m√≥vil peque√±o) -->
          <p class="text-sm text-gray-600 mb-4 text-center sm:text-left">
            Mostrando
            <span class="font-semibold">{{
              (paginaActual() - 1) * productosPorPagina() + 1
            }}</span>
            -
            <span class="font-semibold">{{
              Math.min(paginaActual() * productosPorPagina(), totalProductos())
            }}</span>
            de
            <span class="font-semibold">{{ totalProductos() }}</span>
            productos
          </p>

          <!-- Controles de paginaci√≥n -->
          <div
            class="flex flex-col sm:flex-row items-center justify-center sm:justify-between gap-3"
          >
            <!-- VERSI√ìN M√ìVIL (< 640px) -->
            <div
              class="flex sm:hidden items-center justify-center gap-2 w-full"
            >
              <!-- Bot√≥n Primera P√°gina -->
              <button
                (click)="irAPagina(1)"
                [disabled]="paginaActual() === 1"
                class="p-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="Primera p√°gina"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 19l-7-7 7-7m8 14l-7-7 7-7"
                  ></path>
                </svg>
              </button>

              <!-- Bot√≥n Anterior -->
              <button
                (click)="paginaAnterior()"
                [disabled]="paginaActual() === 1"
                class="flex-1 px-4 py-3 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-1"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  ></path>
                </svg>
                <span class="text-sm">Anterior</span>
              </button>

              <!-- Indicador de P√°gina -->
              <div
                class="px-4 py-3 bg-linear-to-r from-blue-600 to-blue-700 text-white rounded-lg font-bold text-center min-w-22.5 shadow-md"
              >
                <div class="text-xs text-blue-100">P√°gina</div>
                <div class="text-base">
                  {{ paginaActual() }} / {{ totalPaginas() }}
                </div>
              </div>

              <!-- Bot√≥n Siguiente -->
              <button
                (click)="paginaSiguiente()"
                [disabled]="paginaActual() >= totalPaginas()"
                class="flex-1 px-4 py-3 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-1"
              >
                <span class="text-sm">Siguiente</span>
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  ></path>
                </svg>
              </button>

              <!-- Bot√≥n √öltima P√°gina -->
              <button
                (click)="irAPagina(totalPaginas())"
                [disabled]="paginaActual() >= totalPaginas()"
                class="p-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="√öltima p√°gina"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 5l7 7-7 7M5 5l7 7-7 7"
                  ></path>
                </svg>
              </button>
            </div>

            <!-- VERSI√ìN DESKTOP (‚â• 640px) -->
            <div
              class="hidden sm:flex items-center gap-3 w-full justify-center lg:justify-end"
            >
              <!-- Bot√≥n Primera P√°gina -->
              <button
                (click)="irAPagina(1)"
                [disabled]="paginaActual() === 1"
                class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="Primera p√°gina"
              >
                ‚èÆÔ∏è
              </button>

              <!-- Bot√≥n Anterior -->
              <button
                (click)="paginaAnterior()"
                [disabled]="paginaActual() === 1"
                class="px-6 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                ‚Üê Anterior
              </button>

              <!-- Indicador de P√°gina Central -->
              <div
                class="px-6 py-2 bg-linear-to-r from-blue-600 to-blue-700 text-white rounded-lg font-bold shadow-lg"
              >
                {{ paginaActual() }} / {{ totalPaginas() }}
              </div>

              <!-- Bot√≥n Siguiente -->
              <button
                (click)="paginaSiguiente()"
                [disabled]="paginaActual() >= totalPaginas()"
                class="px-6 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Siguiente ‚Üí
              </button>

              <!-- Bot√≥n √öltima P√°gina -->
              <button
                (click)="irAPagina(totalPaginas())"
                [disabled]="paginaActual() >= totalPaginas()"
                class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                title="√öltima p√°gina"
              >
                ‚è≠Ô∏è
              </button>
            </div>
          </div>

          <!-- Input de Salto de P√°gina (solo desktop) -->
          <div class="hidden sm:flex items-center justify-center gap-2 mt-4">
            <label class="text-sm text-gray-600">Ir a p√°gina:</label>
            <input
              type="number"
              [min]="1"
              [max]="totalPaginas()"
              [value]="paginaActual()"
              (change)="irAPaginaInput($event)"
              class="w-20 px-3 py-1 border-2 border-gray-300 rounded-lg text-center focus:border-blue-500 focus:outline-none"
            />
            <span class="text-sm text-gray-500">de {{ totalPaginas() }}</span>
          </div>
        </div>
        } }
      </div>

      <!-- ============================= -->
      <!-- CARRITO (1/3 en desktop, oculto en m√≥vil) -->
      <!-- ============================= -->
      <div
        class="hidden lg:block bg-white rounded-lg shadow-sm p-4 h-fit lg:sticky lg:top-4"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Carrito</h2>

          @if (carrito().length > 0) {
          <button
            (click)="limpiarCarrito()"
            class="text-sm text-red-600 hover:text-red-800 font-semibold"
          >
            Limpiar
          </button>
          }
        </div>

        @if (carrito().length === 0) {
        <div class="text-center py-8 text-gray-500">
          <p>Carrito vac√≠o</p>
          <p class="text-xs mt-2">Selecciona productos para agregar</p>
        </div>
        } @else {
        <!-- Items del carrito -->
        <div class="space-y-2 mb-4 max-h-96 overflow-y-auto">
          @for (item of carrito(); track item.productoId) {
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-gray-800 truncate">
                {{ item.nombreProducto }}
              </div>
              <div class="text-xs text-gray-600">
                ${{ item.precioUnitario.toLocaleString("es-MX") }} c/u
              </div>
            </div>

            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1 bg-white rounded border">
                <button
                  (click)="decrementarCantidad(item.productoId)"
                  class="px-2 py-1 hover:bg-gray-100 text-gray-600 font-semibold"
                >
                  ‚àí
                </button>

                <span class="px-2 text-sm font-bold">{{ item.cantidad }}</span>

                <button
                  (click)="incrementarCantidad(item.productoId)"
                  [disabled]="item.cantidad >= item.stockDisponible"
                  class="px-2 py-1 hover:bg-gray-100 disabled:opacity-50 text-gray-600 font-semibold"
                >
                  +
                </button>
              </div>

              <div class="text-sm font-bold text-gray-800 min-w-15 text-right">
                ${{ item.subtotal.toLocaleString("es-MX") }}
              </div>

              <button
                (click)="eliminarDelCarrito(item.productoId)"
                class="text-red-600 hover:text-red-800 font-bold text-lg"
                title="Eliminar"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
          }
        </div>

        <!-- Resumen -->
        <div class="border-t pt-4 space-y-2">
          <div class="flex justify-between text-sm text-gray-600">
            <span>Items:</span>
            <span class="font-semibold">{{ cantidadItems() }}</span>
          </div>

          <div class="flex justify-between items-center text-xl font-bold">
            <span>Total:</span>
            <span class="text-green-600">
              ${{ total().toLocaleString("es-MX") }}
            </span>
          </div>
        </div>
        }

        <!-- Bot√≥n Finalizar -->
        <button
          (click)="abrirModalVenta()"
          class="w-full mt-4 bg-linear-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:from-gray-400 disabled:to-gray-500 disabled:scale-100 disabled:cursor-not-allowed shadow-lg flex items-center justify-center gap-2"
          [disabled]="carrito().length === 0"
        >
          <span class="text-2xl">üí∞</span>
          <span>FINALIZAR VENTA</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- ‚úÖ NUEVO: BOT√ìN FLOTANTE CARRITO (SOLO M√ìVIL) -->
  <!-- ============================= -->
  <div class="lg:hidden fixed bottom-4 right-4 z-40">
    <button
      (click)="alternarCarritoMovil()"
      class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-2xl relative"
    >
      <span class="text-3xl">üõí</span>
      @if (cantidadItems() > 0) {
      <span
        class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center"
      >
        {{ cantidadItems() }}
      </span>
      }
    </button>
  </div>

  <!-- ============================= -->
  <!-- ‚úÖ NUEVO: MODAL CARRITO M√ìVIL -->
  <!-- ============================= -->
  @if (mostrarCarritoMovil()) {
  <div class="lg:hidden fixed inset-0 z-50 overflow-y-auto">
    <!-- Overlay -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50"
      (click)="alternarCarritoMovil()"
    ></div>

    <!-- Modal -->
    <div
      class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl max-h-[80vh] overflow-hidden"
    >
      <!-- Header -->
      <div
        class="flex items-center justify-between p-4 border-b bg-linear-to-r from-blue-600 to-blue-700 rounded-t-3xl"
      >
        <div>
          <h2 class="text-xl font-bold text-white">Carrito de Compras</h2>
          <p class="text-sm text-blue-100">
            {{ cantidadItems() }}
            {{ cantidadItems() === 1 ? "producto" : "productos" }}
          </p>
        </div>

        <button
          (click)="alternarCarritoMovil()"
          class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="p-4 overflow-y-auto max-h-[50vh]">
        @if (carrito().length === 0) {
        <div class="text-center py-8 text-gray-500">
          <p class="text-lg">Carrito vac√≠o</p>
          <p class="text-sm mt-2">Agrega productos para comenzar</p>
        </div>
        } @else {
        <div class="space-y-3">
          @for (item of carrito(); track item.productoId) {
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <p class="font-semibold text-gray-800">
                  {{ item.nombreProducto }}
                </p>
                <p class="text-sm text-gray-600">
                  ${{ item.precioUnitario.toLocaleString("es-MX") }} c/u
                </p>
              </div>

              <button
                (click)="eliminarDelCarrito(item.productoId)"
                class="text-red-600 hover:text-red-800 font-bold text-xl"
              >
                üóëÔ∏è
              </button>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 bg-white rounded-lg border-2">
                <button
                  (click)="decrementarCantidad(item.productoId)"
                  class="px-3 py-2 hover:bg-gray-100 font-bold"
                >
                  ‚àí
                </button>

                <span class="px-3 font-bold">{{ item.cantidad }}</span>

                <button
                  (click)="incrementarCantidad(item.productoId)"
                  [disabled]="item.cantidad >= item.stockDisponible"
                  class="px-3 py-2 hover:bg-gray-100 disabled:opacity-50 font-bold"
                >
                  +
                </button>
              </div>

              <p class="text-lg font-bold text-green-600">
                ${{ item.subtotal.toLocaleString("es-MX") }}
              </p>
            </div>
          </div>
          }
        </div>
        }
      </div>

      <!-- Footer -->
      @if (carrito().length > 0) {
      <div class="border-t p-4 space-y-3 bg-gray-50">
        <div class="flex justify-between text-lg font-bold">
          <span>Total:</span>
          <span class="text-green-600">
            ${{ total().toLocaleString("es-MX") }}
          </span>
        </div>

        <button
          (click)="abrirModalVenta()"
          class="w-full bg-linear-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 rounded-lg shadow-lg flex items-center justify-center gap-2"
        >
          <span class="text-2xl">üí∞</span>
          <span>FINALIZAR VENTA</span>
        </button>

        <button
          (click)="limpiarCarrito(); alternarCarritoMovil()"
          class="w-full bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-3 rounded-lg"
        >
          üóëÔ∏è Limpiar Carrito
        </button>
      </div>
      }
    </div>
  </div>
  }

  <!-- ============================= -->
  <!-- MODAL FINALIZAR VENTA -->
  <!-- ============================= -->
  @if (mostrarModalVenta()) {
  <div class="fixed inset-0 z-50 overflow-y-auto">
    <!-- Overlay con animaci√≥n de fade -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300"
      (click)="cerrarModalVenta()"
    ></div>

    <!-- Modal Container -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-auto transform transition-all duration-300 animate-slide-up"
      >
        <!-- ============================= -->
        <!-- HEADER DEL MODAL -->
        <!-- ============================= -->
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200 bg-linear-to-r from-blue-600 to-blue-700 rounded-t-2xl"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl"
            >
              üí∞
            </div>
            <div>
              <h2 class="text-2xl font-bold text-white">Finalizar Venta</h2>
              <p class="text-sm text-blue-100">
                {{ cantidadItems() }}
                {{ cantidadItems() === 1 ? "producto" : "productos" }} en el
                carrito
              </p>
            </div>
          </div>

          <button
            (click)="cerrarModalVenta()"
            class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
            title="Cerrar (ESC)"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ============================= -->
        <!-- CONTENIDO DEL MODAL -->
        <!-- ============================= -->
        <div class="p-6 max-h-[70vh] overflow-y-auto">
          <!-- ============================= -->
          <!-- SECCI√ìN 1: RESUMEN DEL CARRITO -->
          <!-- ============================= -->
          <div class="mb-6">
            <h3
              class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"
            >
              <span>üõí</span>
              <span>Resumen de Compra</span>
            </h3>

            <div
              class="bg-gray-50 rounded-lg p-4 space-y-2 max-h-48 overflow-y-auto"
            >
              @for (item of carrito(); track item.productoId) {
              <div class="flex items-center justify-between text-sm">
                <div class="flex-1">
                  <span class="font-semibold text-gray-800">{{
                    item.nombreProducto
                  }}</span>
                  <span class="text-gray-500 ml-2">√ó {{ item.cantidad }}</span>
                </div>
                <span class="font-bold text-gray-800">
                  ${{ item.subtotal.toLocaleString("es-MX") }}
                </span>
              </div>
              }
            </div>

            <!-- Totales Parciales -->
            <div class="mt-4 space-y-2 border-t border-gray-200 pt-4">
              <div class="flex justify-between text-sm text-gray-600">
                <span>Subtotal:</span>
                <span class="font-semibold"
                  >${{ total().toLocaleString("es-MX") }}</span
                >
              </div>

              @if (descuento() > 0) {
              <div class="flex justify-between text-sm text-green-600">
                <span>Descuento:</span>
                <span class="font-semibold"
                  >-${{ descuento().toLocaleString("es-MX") }}</span
                >
              </div>
              } @if (gananciaTotal() > 0) {
              <div class="flex justify-between text-sm text-blue-600">
                <span>üíé Ganancia:</span>
                <span class="font-bold"
                  >+${{ gananciaTotal().toLocaleString("es-MX") }}</span
                >
              </div>
              }
            </div>
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 2: SELECTOR DE CLIENTE -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2"
            >
              <span>üë§</span>
              <span>Cliente (Opcional)</span>
              @if (metodoPago() === 'fiado') {
              <span class="text-red-600 text-xs">* Requerido para cr√©dito</span>
              }
            </label>

            @if (clienteSeleccionado()) {
            <!-- Cliente Seleccionado -->
            <div
              class="flex items-center justify-between p-4 bg-linear-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white text-xl font-bold"
                >
                  {{ clienteSeleccionado()!.nombre.charAt(0)
                  }}{{ clienteSeleccionado()!.apellido.charAt(0) }}
                </div>
                <div>
                  <p class="font-bold text-gray-900">
                    {{ clienteSeleccionado()!.nombre }}
                    {{ clienteSeleccionado()!.apellido }}
                  </p>
                  <p class="text-sm text-gray-600">
                    Saldo actual: ${{
                      clienteSeleccionado()!.saldoActual.toLocaleString("es-MX")
                    }}
                  </p>
                </div>
              </div>

              <button
                (click)="limpiarCliente()"
                class="text-red-600 hover:bg-red-100 rounded-full p-2 transition-colors"
                title="Quitar cliente"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>

            <!-- Alerta de L√≠mite Excedido -->
            @if (metodoPago() === 'fiado' && !puedeVenderFiado()) {
            <div
              class="mt-2 flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800"
            >
              <span class="text-lg">‚ö†Ô∏è</span>
              <div>
                <p class="font-semibold">L√≠mite de cr√©dito excedido</p>
                <p class="text-xs mt-1">
                  Disponible: ${{
                    saldoDisponibleFiado().toLocaleString("es-MX")
                  }}
                  | Venta: ${{ totalConDescuento().toLocaleString("es-MX") }}
                </p>
              </div>
            </div>
            } } @else {
            <!-- Buscador de Clientes -->
            <div class="space-y-3">
              <div class="relative">
                <input
                  type="text"
                  [value]="busquedaCliente()"
                  (input)="actualizarBusquedaCliente($event)"
                  (focus)="mostrarListaClientes.set(true)"
                  (blur)="cerrarListaClientes()"
                  placeholder="Buscar por nombre o identificaci√≥n..."
                  class="w-full px-4 py-3 pl-12 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                />

                <span
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"
                >
                  üîç
                </span>

                <!-- Lista de Clientes Filtrados -->
                @if (mostrarListaClientes() && clientesFiltrados().length > 0) {
                <div
                  class="absolute z-10 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto"
                >
                  @for (cliente of clientesFiltrados(); track cliente._id) {
                  <button
                    (mousedown)="seleccionarCliente(cliente)"
                    class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors border-b last:border-b-0 flex items-center justify-between"
                  >
                    <div>
                      <p class="font-semibold text-gray-900">
                        {{ cliente.nombre }} {{ cliente.apellido }}
                      </p>
                      <p class="text-xs text-gray-500">
                        {{ cliente.identificacion || "Sin c√©dula" }}
                      </p>
                    </div>
                    <span
                      class="text-sm font-bold"
                      [class.text-red-600]="cliente.saldoActual > 0"
                      [class.text-green-600]="cliente.saldoActual === 0"
                    >
                      ${{ cliente.saldoActual.toLocaleString("es-MX") }}
                    </span>
                  </button>
                  }
                </div>
                }

                <!-- Sin Resultados -->
                @if (mostrarListaClientes() && busquedaCliente().length >= 2 &&
                clientesFiltrados().length === 0) {
                <div
                  class="absolute z-10 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl p-4 text-center text-gray-500"
                >
                  <p class="text-sm mb-3">No se encontraron clientes</p>
                  <!-- ‚úÖ AGREGAR BOT√ìN DE CREAR CLIENTE -->
                  <button
                    (mousedown)="abrirModalCrearCliente()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
                  >
                    <span class="text-lg">‚ûï</span>
                    <span>Crear Cliente Nuevo</span>
                  </button>
                </div>
                }
              </div>

              <!-- ‚úÖ BOT√ìN ALTERNATIVO: Crear Cliente (visible siempre) -->
              <button
                (click)="abrirModalCrearCliente()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-all transform hover:scale-105 flex items-center justify-center gap-2 shadow-md"
              >
                <span class="text-xl">‚ûï</span>
                <span>Crear Cliente Nuevo</span>
              </button>
            </div>
            }
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 3: M√âTODO DE PAGO -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <span>üí≥</span>
              <span>M√©todo de Pago</span>
            </label>

            <div class="grid grid-cols-2 gap-3">
              @for (metodo of METODOS_PAGO_DISPONIBLES; track metodo.valor) {
              <button
                (click)="cambiarMetodoPago(metodo.valor)"
                [class.bg-gradient-to-br]="metodoPago() === metodo.valor"
                [class.from-blue-600]="metodoPago() === metodo.valor"
                [class.to-blue-700]="metodoPago() === metodo.valor"
                [class.text-white]="metodoPago() === metodo.valor"
                [class.border-blue-600]="metodoPago() === metodo.valor"
                [class.shadow-lg]="metodoPago() === metodo.valor"
                [class.bg-white]="metodoPago() !== metodo.valor"
                [class.border-gray-300]="metodoPago() !== metodo.valor"
                [class.hover:border-blue-400]="metodoPago() !== metodo.valor"
                class="flex flex-col items-center justify-center p-4 border-2 rounded-lg transition-all duration-200 transform hover:scale-105"
              >
                <span class="text-3xl mb-2">{{ metodo.icono }}</span>
                <span class="text-sm font-semibold">{{ metodo.etiqueta }}</span>
              </button>
              }
            </div>

            @if (metodoPago() === 'efectivo') {
            <div
              class="mt-3 p-4 bg-green-50 border border-green-200 rounded-lg"
            >
              <label
                class="text-sm font-semibold text-green-800 mb-2 flex items-center gap-2"
              >
                <span>üíµ</span>
                <span>Monto Pagado (Opcional)</span>
              </label>

              <div class="flex items-center gap-3">
                <span class="text-green-700 font-bold text-lg">$</span>
                <input
                  type="number"
                  [value]="montoPagadoEfectivo()"
                  (input)="actualizarMontoPagadoEfectivo($event)"
                  min="0"
                  step="100"
                  placeholder="0.00"
                  class="flex-1 px-4 py-2 border-2 border-green-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-right font-semibold"
                />
                <button
                  (click)="aplicarMontoExacto()"
                  class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors"
                  title="Aplicar monto exacto"
                >
                  Exacto
                </button>
              </div>

              <!-- Mostrar Cambio -->
              @if (montoPagadoEfectivo() > 0) {
              <div class="mt-3 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-green-700">Total a pagar:</span>
                  <span class="font-bold text-green-800"
                    >${{ totalFinal().toLocaleString("es-MX") }}</span
                  >
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-green-700">Monto pagado:</span>
                  <span class="font-bold text-green-800"
                    >${{ montoPagadoEfectivo().toLocaleString("es-MX") }}</span
                  >
                </div>
                <div
                  class="flex justify-between text-base border-t border-green-300 pt-2"
                >
                  <span class="font-semibold text-green-800">Cambio:</span>
                  <span
                    class="text-xl font-black"
                    [class.text-green-600]="cambioEfectivo() >= 0"
                    [class.text-red-600]="cambioEfectivo() < 0"
                  >
                    ${{ cambioEfectivo().toLocaleString("es-MX") }}
                  </span>
                </div>
              </div>

              <!-- Alerta si el monto es insuficiente -->
              @if (montoPagadoEfectivo() > 0 && !esMontoPagadoSuficiente()) {
              <div
                class="mt-2 flex items-center gap-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-800"
              >
                <span>‚ö†Ô∏è</span>
                <span
                  >Monto insuficiente. Faltan ${{
                    (totalFinal() - montoPagadoEfectivo()).toLocaleString(
                      "es-MX"
                    )
                  }}</span
                >
              </div>
              } }

              <p class="text-xs text-green-600 mt-2">
                üí° Deja en blanco si no necesitas calcular el cambio
              </p>
            </div>
            }

            <!-- Input de comisi√≥n si es TARJETA -->
            @if (metodoPago() === 'tarjeta') {
            <div class="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <label
                class="text-sm font-semibold text-blue-800 mb-2 flex items-center gap-2"
              >
                <span>üí≥</span>
                <span>Comisi√≥n de Terminal (%)</span>
              </label>

              <div class="flex items-center gap-3">
                <input
                  type="number"
                  [value]="comisionTerminal()"
                  (input)="actualizarComisionTerminal($event)"
                  min="0"
                  max="10"
                  step="0.5"
                  class="flex-1 px-4 py-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-center font-semibold"
                />
                <span class="text-sm text-blue-700 font-semibold">%</span>
              </div>

              <div class="mt-2 flex justify-between text-sm text-blue-700">
                <span>Comisi√≥n calculada:</span>
                <span class="font-bold"
                  >+${{ montoComisionTerminal().toLocaleString("es-MX") }}</span
                >
              </div>

              <p class="text-xs text-blue-600 mt-2">
                üí° Comisiones t√≠picas: Mercado Pago 3.5%, Clip 3.6%, Terminal
                2.9%
              </p>
            </div>
            }

            <!-- Alerta de Fiado sin Cliente -->
            @if (metodoPago() === 'fiado' && !clienteSeleccionado()) {
            <div
              class="mt-3 flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-sm text-yellow-800"
            >
              <span class="text-lg">‚ö†Ô∏è</span>
              <span>Debes seleccionar un cliente para venta a cr√©dito</span>
            </div>
            }
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 4: DESCUENTO -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2"
            >
              <span>üéÅ</span>
              <span>Descuento (Opcional)</span>
            </label>

            <div class="relative">
              <span
                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-lg"
                >$</span
              >
              <input
                type="number"
                [value]="descuento()"
                (input)="actualizarDescuento($event)"
                min="0"
                [max]="total()"
                step="10"
                placeholder="0.00"
                class="w-full px-4 py-3 pl-10 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-right font-semibold"
              />
            </div>

            <!-- Botones de Descuento R√°pido -->
            <div class="mt-2 flex gap-2">
              @for (descuentoRapido of [50, 100, 200, 500]; track
              descuentoRapido) {
              <button
                (click)="aplicarDescuento(descuentoRapido)"
                class="flex-1 px-3 py-2 text-xs font-semibold bg-green-50 hover:bg-green-100 text-green-700 border border-green-300 rounded transition-colors"
                [disabled]="descuentoRapido > total()"
                [class.opacity-50]="descuentoRapido > total()"
                [class.cursor-not-allowed]="descuentoRapido > total()"
              >
                -${{ descuentoRapido }}
              </button>
              }
            </div>
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 5: TOTALES FINALES -->
          <!-- ============================= -->
          <div
            class="bg-linear-to-r from-gray-50 to-gray-100 rounded-xl p-6 border-2 border-gray-200"
          >
            <div class="space-y-3">
              <div class="flex justify-between text-base text-gray-700">
                <span>Subtotal:</span>
                <span class="font-semibold"
                  >${{ total().toLocaleString("es-MX") }}</span
                >
              </div>

              @if (descuento() > 0) {
              <div class="flex justify-between text-base text-green-600">
                <span>Descuento:</span>
                <span class="font-semibold"
                  >-${{ descuento().toLocaleString("es-MX") }}</span
                >
              </div>
              } @if (metodoPago() === 'tarjeta' && montoComisionTerminal() > 0)
              {
              <div class="flex justify-between text-base text-orange-600">
                <span>Comisi√≥n Terminal ({{ comisionTerminal() }}%):</span>
                <span class="font-semibold"
                  >+${{ montoComisionTerminal().toLocaleString("es-MX") }}</span
                >
              </div>
              }

              <div
                class="border-t-2 border-gray-300 pt-3 flex justify-between items-center"
              >
                <span class="text-2xl font-bold text-gray-800"
                  >TOTAL A PAGAR:</span
                >
                <span class="text-3xl font-black text-green-600">
                  ${{ totalFinal().toLocaleString("es-MX") }}
                </span>
              </div>

              @if (metodoPago() === 'fiado' && clienteSeleccionado()) {
              <div
                class="flex justify-between text-sm text-blue-600 bg-blue-50 p-3 rounded-lg"
              >
                <span>Nuevo saldo del cliente:</span>
                <span class="font-bold">
                  ${{
                    (
                      clienteSeleccionado()!.saldoActual + totalFinal()
                    ).toLocaleString("es-MX")
                  }}
                </span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- ============================= -->
        <!-- FOOTER DEL MODAL (BOTONES) -->
        <!-- ============================= -->
        <div
          class="flex items-center justify-between gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl"
        >
          <button
            (click)="cerrarModalVenta()"
            class="flex-1 px-6 py-3 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg transition-colors"
            [disabled]="loading()"
          >
            Cancelar
          </button>

          <button
            (click)="confirmarVenta()"
            [disabled]="!puedeFinalizarVenta() || loading()"
            class="flex-1 px-6 py-4 bg-linear-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            @if (loading()) {
            <svg
              class="animate-spin h-5 w-5 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span>Procesando...</span>
            } @else {
            <span class="text-xl">üí∞</span>
            <span>COBRAR ${{ totalFinal().toLocaleString("es-MX") }}</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }
  <!-- MODAL CREAR CLIENTE (SIN CAMBIOS) -->
  @if (mostrarModalCrearCliente()) {
  <app-modal-cliente
    [modoEdicion]="false"
    (onCerrar)="cerrarModalCrearCliente()"
    (onGuardar)="guardarClienteNuevo($event)"
  />
  }
</div>
