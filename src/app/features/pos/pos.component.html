<div class="min-h-screen bg-gray-50 p-4 overflow-auto">
  <div class="max-w-7xl mx-auto">
    <!-- Mensaje de Alerta -->
    @if (mensajeAlerta()) {
    <div
      class="mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded animate-pulse"
    >
      <p class="text-sm font-semibold">{{ mensajeAlerta() }}</p>
    </div>
    }

    <!-- Grid principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Productos (2/3) -->
      <div class="lg:col-span-2 bg-white rounded-lg shadow-sm p-4">
        <!-- Header con Buscador -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">
            Productos ({{ productos().length }})
          </h2>
        </div>

        <!-- üîç Buscador -->
        <div class="mb-4 relative">
          <input
            type="text"
            [value]="terminoBusqueda()"
            (input)="actualizarBusqueda($event)"
            placeholder="Buscar por nombre, c√≥digo o categor√≠a..."
            class="w-full px-4 py-3 pl-12 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
          />
          <span
            class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"
          >
            üîç
          </span>

          @if (terminoBusqueda()) {
          <button
            (click)="limpiarBusqueda()"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 font-bold"
          >
            ‚úï
          </button>
          }
        </div>

        <!-- Loading State -->
        @if (loading()) {
        <div class="text-center py-12">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"
          ></div>
          <p class="text-gray-600 mt-4">Cargando productos...</p>
        </div>
        }

        <!-- Error State -->
        @else if (error()) {
        <div class="text-center py-12">
          <div class="text-red-600 text-5xl mb-4">‚ö†Ô∏è</div>
          <p class="text-red-600 text-lg font-semibold">{{ error() }}</p>
          <button
            (click)="recargarProductos()"
            class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
          >
            Reintentar
          </button>
        </div>
        }

        <!-- Empty State (Sin Productos) -->
        @else if (productos().length === 0 && !terminoBusqueda()) {
        <div class="text-center py-12 text-gray-500">
          <p class="text-lg">No hay productos disponibles</p>
          <p class="text-sm mt-2">Agrega productos desde el inventario</p>
        </div>
        }

        <!-- Empty State (Sin Resultados de B√∫squeda) -->
        @else if (productos().length === 0 && terminoBusqueda()) {
        <div class="text-center py-12 text-gray-500">
          <div class="text-5xl mb-4">üîç</div>
          <p class="text-lg font-semibold">No se encontraron productos</p>
          <p class="text-sm mt-2">
            Intenta buscar con otro t√©rmino: "{{ terminoBusqueda() }}"
          </p>
          <button
            (click)="limpiarBusqueda()"
            class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
          >
            Limpiar b√∫squeda
          </button>
        </div>
        }

        <!-- Grid de Productos -->
        @else {
        <div
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"
        >
          @for (producto of productos(); track producto._id) {
          <button
            (click)="agregarAlCarrito(producto)"
            class="bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-400 rounded-lg p-3 text-left transition-all relative"
            [disabled]="!puedeAgregarMas(producto)"
            [class.opacity-50]="!puedeAgregarMas(producto)"
            [class.cursor-not-allowed]="!puedeAgregarMas(producto)"
          >
            @if (obtenerCantidadEnCarrito(producto._id) > 0) {
            <span
              class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center shadow-md z-10"
            >
              {{ obtenerCantidadEnCarrito(producto._id) }}
            </span>
            }

            <!-- üì¶ Nombre del Producto -->
            <div class="text-sm font-semibold text-gray-800 mb-1 truncate">
              {{ producto.nombre }}
            </div>

            <!-- üè∑Ô∏è C√≥digo de Barras -->
            @if (producto.codigoBarras) {
            <div
              class="text-xs text-gray-500 font-mono mb-2 flex items-center gap-1"
            >
              <span>üìä</span>
              <span>{{ producto.codigoBarras }}</span>
            </div>
            }

            <!-- üí∞ Precio -->
            <div class="text-lg font-bold text-green-600 mb-2">
              ${{ producto.precioVenta.toLocaleString("es-MX") }}
            </div>

            <!-- üì¶ Stock + Estado -->
            <div class="text-xs mt-2 space-y-1">
              @if (producto.stock === 0) {
              <div class="flex items-center gap-1 text-red-600 font-semibold">
                <span>‚ùå</span>
                <span>Sin stock</span>
              </div>
              } @else if (producto.stock < producto.stockMinimo) {
              <div
                class="flex items-center gap-1 text-yellow-600 font-semibold"
              >
                <span>‚ö†Ô∏è</span>
                <span>Stock bajo: {{ producto.stock }}</span>
              </div>
              } @else {
              <div class="flex items-center gap-1 text-gray-600">
                <span>‚úÖ</span>
                <span>Stock: {{ producto.stock }}</span>
              </div>
              }

              <!-- Cantidad en Carrito -->
              @if (obtenerCantidadEnCarrito(producto._id) > 0) {
              <div class="flex items-center gap-1 text-blue-600 font-semibold">
                <span>üõí</span>
                <span>
                  En carrito: {{ obtenerCantidadEnCarrito(producto._id) }}/{{
                    producto.stock
                  }}
                </span>
              </div>
              }

              <!-- Categor√≠a -->
              @if (producto.categoria) {
              <div class="flex items-center gap-1 text-gray-500">
                <span>üè∑Ô∏è</span>
                <span class="truncate">{{ producto.categoria }}</span>
              </div>
              }
            </div>
          </button>
          }
        </div>
        }
      </div>

      <!-- Carrito (1/3) -->
      <div class="bg-white rounded-lg shadow-sm p-4 h-fit lg:sticky lg:top-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Carrito</h2>

          @if (carrito().length > 0) {
          <button
            (click)="limpiarCarrito()"
            class="text-sm text-red-600 hover:text-red-800 font-semibold"
          >
            Limpiar
          </button>
          }
        </div>

        @if (carrito().length === 0) {
        <div class="text-center py-8 text-gray-500">
          <p>Carrito vac√≠o</p>
          <p class="text-xs mt-2">Selecciona productos para agregar</p>
        </div>
        } @else {
        <!-- Items del carrito -->
        <div class="space-y-2 mb-4 max-h-96 overflow-y-auto">
          @for (item of carrito(); track item.productoId) {
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-gray-800 truncate">
                {{ item.nombreProducto }}
              </div>
              <div class="text-xs text-gray-600">
                ${{ item.precioUnitario.toLocaleString("es-MX") }} c/u
                <span
                  class="ml-1"
                  [class.text-red-600]="item.cantidad === item.stockDisponible"
                  [class.text-yellow-600]="
                    item.cantidad >= item.stockDisponible * 0.8 &&
                    item.cantidad < item.stockDisponible
                  "
                >
                  ({{ item.cantidad }}/{{ item.stockDisponible }})
                </span>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1 bg-white rounded border">
                <button
                  (click)="decrementarCantidad(item.productoId)"
                  class="px-2 py-1 hover:bg-gray-100 text-gray-600 font-semibold"
                >
                  ‚àí
                </button>

                <span class="px-2 text-sm font-bold">{{ item.cantidad }}</span>

                <button
                  (click)="incrementarCantidad(item.productoId)"
                  class="px-2 py-1 hover:bg-gray-100 text-gray-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  [disabled]="item.cantidad >= item.stockDisponible"
                >
                  +
                </button>
              </div>

              <div class="text-sm font-bold text-gray-800 min-w-15 text-right">
                ${{ item.subtotal.toLocaleString("es-MX") }}
              </div>

              <button
                (click)="eliminarDelCarrito(item.productoId)"
                class="text-red-600 hover:text-red-800 font-bold text-lg"
                title="Eliminar"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
          }
        </div>

        <!-- Resumen -->
        <div class="border-t pt-4 space-y-2">
          <div class="flex justify-between text-sm text-gray-600">
            <span>Items:</span>
            <span class="font-semibold">{{ cantidadItems() }}</span>
          </div>

          <div class="flex justify-between items-center text-xl font-bold">
            <span>Total:</span>
            <span class="text-green-600">
              ${{ total().toLocaleString("es-MX") }}
            </span>
          </div>
        </div>
        }

        <!-- Bot√≥n Finalizar -->
        <button
          (click)="abrirModalVenta()"
          class="w-full mt-4 bg-linear-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 disabled:from-gray-400 disabled:to-gray-500 disabled:scale-100 disabled:cursor-not-allowed shadow-lg flex items-center justify-center gap-2"
          [disabled]="carrito().length === 0"
        >
          <span class="text-2xl">üí∞</span>
          <span>FINALIZAR VENTA</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- MODAL FINALIZAR VENTA -->
  <!-- ============================= -->
  @if (mostrarModalVenta()) {
  <div class="fixed inset-0 z-50 overflow-y-auto">
    <!-- Overlay con animaci√≥n de fade -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300"
      (click)="cerrarModalVenta()"
    ></div>

    <!-- Modal Container -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-auto transform transition-all duration-300 animate-slide-up"
      >
        <!-- ============================= -->
        <!-- HEADER DEL MODAL -->
        <!-- ============================= -->
        <div
          class="flex items-center justify-between p-6 border-b border-gray-200 bg-linear-to-r from-blue-600 to-blue-700 rounded-t-2xl"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl"
            >
              üí∞
            </div>
            <div>
              <h2 class="text-2xl font-bold text-white">Finalizar Venta</h2>
              <p class="text-sm text-blue-100">
                {{ cantidadItems() }}
                {{ cantidadItems() === 1 ? "producto" : "productos" }} en el
                carrito
              </p>
            </div>
          </div>

          <button
            (click)="cerrarModalVenta()"
            class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
            title="Cerrar (ESC)"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ============================= -->
        <!-- CONTENIDO DEL MODAL -->
        <!-- ============================= -->
        <div class="p-6 max-h-[70vh] overflow-y-auto">
          <!-- ============================= -->
          <!-- SECCI√ìN 1: RESUMEN DEL CARRITO -->
          <!-- ============================= -->
          <div class="mb-6">
            <h3
              class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"
            >
              <span>üõí</span>
              <span>Resumen de Compra</span>
            </h3>

            <div
              class="bg-gray-50 rounded-lg p-4 space-y-2 max-h-48 overflow-y-auto"
            >
              @for (item of carrito(); track item.productoId) {
              <div class="flex items-center justify-between text-sm">
                <div class="flex-1">
                  <span class="font-semibold text-gray-800">{{
                    item.nombreProducto
                  }}</span>
                  <span class="text-gray-500 ml-2">√ó {{ item.cantidad }}</span>
                </div>
                <span class="font-bold text-gray-800">
                  ${{ item.subtotal.toLocaleString("es-MX") }}
                </span>
              </div>
              }
            </div>

            <!-- Totales Parciales -->
            <div class="mt-4 space-y-2 border-t border-gray-200 pt-4">
              <div class="flex justify-between text-sm text-gray-600">
                <span>Subtotal:</span>
                <span class="font-semibold"
                  >${{ total().toLocaleString("es-MX") }}</span
                >
              </div>

              @if (descuento() > 0) {
              <div class="flex justify-between text-sm text-green-600">
                <span>Descuento:</span>
                <span class="font-semibold"
                  >-${{ descuento().toLocaleString("es-MX") }}</span
                >
              </div>
              } @if (gananciaTotal() > 0) {
              <div class="flex justify-between text-sm text-blue-600">
                <span>üíé Ganancia:</span>
                <span class="font-bold"
                  >+${{ gananciaTotal().toLocaleString("es-MX") }}</span
                >
              </div>
              }
            </div>
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 2: SELECTOR DE CLIENTE -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2"
            >
              <span>üë§</span>
              <span>Cliente (Opcional)</span>
              @if (metodoPago() === 'fiado') {
              <span class="text-red-600 text-xs">* Requerido para cr√©dito</span>
              }
            </label>

            @if (clienteSeleccionado()) {
            <!-- Cliente Seleccionado -->
            <div
              class="flex items-center justify-between p-4 bg-linear-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white text-xl font-bold"
                >
                  {{ clienteSeleccionado()!.nombre.charAt(0).toUpperCase() }}
                </div>
                <div>
                  <p class="font-bold text-green-800">
                    {{ clienteSeleccionado()!.nombre }}
                    {{ clienteSeleccionado()!.apellido }}
                  </p>
                  <div class="flex items-center gap-2 text-xs text-green-700">
                    <span
                      >Saldo actual: ${{
                        clienteSeleccionado()!.saldoActual.toLocaleString(
                          "es-MX"
                        )
                      }}</span
                    >
                    @if (metodoPago() === 'fiado') {
                    <span class="px-2 py-0.5 bg-green-200 rounded-full">
                      Disponible: ${{
                        saldoDisponibleFiado().toLocaleString("es-MX")
                      }}
                    </span>
                    }
                  </div>
                </div>
              </div>

              <button
                (click)="limpiarCliente()"
                class="text-red-600 hover:bg-red-100 rounded-full p-2 transition-colors"
                title="Quitar cliente"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>

            <!-- Alerta de L√≠mite Excedido -->
            @if (metodoPago() === 'fiado' && !puedeVenderFiado()) {
            <div
              class="mt-2 flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800"
            >
              <span class="text-lg">‚ö†Ô∏è</span>
              <div>
                <p class="font-semibold">L√≠mite de cr√©dito excedido</p>
                <p class="text-xs mt-1">
                  El cliente alcanzar√≠a ${{
                    (
                      clienteSeleccionado()!.saldoActual + totalConDescuento()
                    ).toLocaleString("es-MX")
                  }}
                  de ${{
                    (
                      clienteSeleccionado()!.limiteCredito ?? 100000
                    ).toLocaleString("es-MX")
                  }}
                  permitidos
                </p>
              </div>
            </div>
            } } @else {
            <!-- Buscador de Clientes -->
            <div class="relative">
              <input
                type="text"
                [value]="busquedaCliente()"
                (input)="actualizarBusquedaCliente($event)"
                (focus)="mostrarListaClientes.set(true)"
                (blur)="cerrarListaClientes()"
                placeholder="Buscar por nombre o identificaci√≥n..."
                class="w-full px-4 py-3 pl-12 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
              />

              <span
                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"
              >
                üîç
              </span>

              <!-- Lista de Clientes Filtrados -->
              @if (mostrarListaClientes() && clientesFiltrados().length > 0) {
              <div
                class="absolute z-10 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto"
              >
                @for (cliente of clientesFiltrados(); track cliente._id) {
                <button
                  (mousedown)="seleccionarCliente(cliente)"
                  class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors border-b last:border-b-0 flex items-center justify-between"
                >
                  <div>
                    <p class="font-semibold text-gray-800">
                      {{ cliente.nombre }} {{ cliente.apellido }}
                    </p>
                    <p class="text-xs text-gray-600">
                      ID: {{ cliente.identificacion }} ¬∑ Saldo: ${{
                        cliente.saldoActual.toLocaleString("es-MX")
                      }}
                    </p>
                  </div>
                  <span class="text-blue-600">‚Üí</span>
                </button>
                }
              </div>
              }

              <!-- Sin Resultados -->
              @if (mostrarListaClientes() && busquedaCliente().length >= 2 &&
              clientesFiltrados().length === 0) {
              <div
                class="absolute z-10 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl p-4 text-center text-gray-500"
              >
                <p class="text-sm">No se encontraron clientes</p>
              </div>
              }
            </div>
            }
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 3: M√âTODO DE PAGO -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <span>üí≥</span>
              <span>M√©todo de Pago</span>
            </label>

            <div class="grid grid-cols-2 gap-3">
              @for (metodo of METODOS_PAGO_DISPONIBLES; track metodo.valor) {
              <button
                (click)="cambiarMetodoPago(metodo.valor)"
                [class.bg-gradient-to-br]="metodoPago() === metodo.valor"
                [class.from-blue-600]="metodoPago() === metodo.valor"
                [class.to-blue-700]="metodoPago() === metodo.valor"
                [class.text-white]="metodoPago() === metodo.valor"
                [class.border-blue-600]="metodoPago() === metodo.valor"
                [class.shadow-lg]="metodoPago() === metodo.valor"
                [class.bg-white]="metodoPago() !== metodo.valor"
                [class.border-gray-300]="metodoPago() !== metodo.valor"
                [class.hover:border-blue-400]="metodoPago() !== metodo.valor"
                class="flex flex-col items-center justify-center p-4 border-2 rounded-lg transition-all duration-200 transform hover:scale-105"
              >
                <span class="text-3xl mb-2">{{ metodo.icono }}</span>
                <span class="text-sm font-semibold">{{ metodo.etiqueta }}</span>
              </button>
              }
            </div>

            @if (metodoPago() === 'efectivo') {
            <div
              class="mt-3 p-4 bg-green-50 border border-green-200 rounded-lg"
            >
              <label
                class="text-sm font-semibold text-green-800 mb-2 flex items-center gap-2"
              >
                <span>üíµ</span>
                <span>Monto Pagado (Opcional)</span>
              </label>

              <div class="flex items-center gap-3">
                <span class="text-green-700 font-bold text-lg">$</span>
                <input
                  type="number"
                  [value]="montoPagadoEfectivo()"
                  (input)="actualizarMontoPagadoEfectivo($event)"
                  min="0"
                  step="100"
                  placeholder="0.00"
                  class="flex-1 px-4 py-2 border-2 border-green-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-right font-semibold"
                />
                <button
                  (click)="aplicarMontoExacto()"
                  class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors"
                  title="Aplicar monto exacto"
                >
                  Exacto
                </button>
              </div>

              <!-- Mostrar Cambio -->
              @if (montoPagadoEfectivo() > 0) {
              <div class="mt-3 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-green-700">Total a pagar:</span>
                  <span class="font-bold text-green-800"
                    >${{ totalFinal().toLocaleString("es-MX") }}</span
                  >
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-green-700">Monto pagado:</span>
                  <span class="font-bold text-green-800"
                    >${{ montoPagadoEfectivo().toLocaleString("es-MX") }}</span
                  >
                </div>
                <div
                  class="flex justify-between text-base border-t border-green-300 pt-2"
                >
                  <span class="font-semibold text-green-800">Cambio:</span>
                  <span
                    class="text-xl font-black"
                    [class.text-green-600]="cambioEfectivo() >= 0"
                    [class.text-red-600]="cambioEfectivo() < 0"
                  >
                    ${{ cambioEfectivo().toLocaleString("es-MX") }}
                  </span>
                </div>
              </div>

              <!-- Alerta si el monto es insuficiente -->
              @if (montoPagadoEfectivo() > 0 && !esMontoPagadoSuficiente()) {
              <div
                class="mt-2 flex items-center gap-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-800"
              >
                <span>‚ö†Ô∏è</span>
                <span
                  >Monto insuficiente. Faltan ${{
                    (totalFinal() - montoPagadoEfectivo()).toLocaleString(
                      "es-MX"
                    )
                  }}</span
                >
              </div>
              } }

              <p class="text-xs text-green-600 mt-2">
                üí° Deja en blanco si no necesitas calcular el cambio
              </p>
            </div>
            }

            <!-- Input de comisi√≥n si es TARJETA -->
            @if (metodoPago() === 'tarjeta') {
            <div class="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <label
                class="text-sm font-semibold text-blue-800 mb-2 flex items-center gap-2"
              >
                <span>üí≥</span>
                <span>Comisi√≥n de Terminal (%)</span>
              </label>

              <div class="flex items-center gap-3">
                <input
                  type="number"
                  [value]="comisionTerminal()"
                  (input)="actualizarComisionTerminal($event)"
                  min="0"
                  max="10"
                  step="0.5"
                  class="flex-1 px-4 py-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-center font-semibold"
                />
                <span class="text-sm text-blue-700 font-semibold">%</span>
              </div>

              <div class="mt-2 flex justify-between text-sm text-blue-700">
                <span>Comisi√≥n calculada:</span>
                <span class="font-bold"
                  >+${{ montoComisionTerminal().toLocaleString("es-MX") }}</span
                >
              </div>

              <p class="text-xs text-blue-600 mt-2">
                üí° Comisiones t√≠picas: Mercado Pago 3.5%, Clip 3.6%, Terminal
                2.9%
              </p>
            </div>
            }

            <!-- Alerta de Fiado sin Cliente -->
            @if (metodoPago() === 'fiado' && !clienteSeleccionado()) {
            <div
              class="mt-3 flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-sm text-yellow-800"
            >
              <span class="text-lg">‚ö†Ô∏è</span>
              <span>Debes seleccionar un cliente para venta a cr√©dito</span>
            </div>
            }
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 4: DESCUENTO -->
          <!-- ============================= -->
          <div class="mb-6">
            <label
              class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2"
            >
              <span>üéÅ</span>
              <span>Descuento (Opcional)</span>
            </label>

            <div class="relative">
              <span
                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-lg"
                >$</span
              >
              <input
                type="number"
                [value]="descuento()"
                (input)="actualizarDescuento($event)"
                min="0"
                [max]="total()"
                step="10"
                placeholder="0.00"
                class="w-full px-4 py-3 pl-10 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-right font-semibold"
              />
            </div>

            <!-- Botones de Descuento R√°pido -->
            <div class="mt-2 flex gap-2">
              @for (descuentoRapido of [50, 100, 200, 500]; track
              descuentoRapido) {
              <button
                (click)="aplicarDescuento(descuentoRapido)"
                class="flex-1 px-3 py-2 text-xs font-semibold bg-green-50 hover:bg-green-100 text-green-700 border border-green-300 rounded transition-colors"
                [disabled]="descuentoRapido > total()"
                [class.opacity-50]="descuentoRapido > total()"
                [class.cursor-not-allowed]="descuentoRapido > total()"
              >
                -${{ descuentoRapido }}
              </button>
              }
            </div>
          </div>

          <!-- ============================= -->
          <!-- SECCI√ìN 5: TOTALES FINALES -->
          <!-- ============================= -->
          <div
            class="bg-linear-to-r from-gray-50 to-gray-100 rounded-xl p-6 border-2 border-gray-200"
          >
            <div class="space-y-3">
              <div class="flex justify-between text-base text-gray-700">
                <span>Subtotal:</span>
                <span class="font-semibold"
                  >${{ total().toLocaleString("es-MX") }}</span
                >
              </div>

              @if (descuento() > 0) {
              <div class="flex justify-between text-base text-green-600">
                <span>Descuento:</span>
                <span class="font-semibold"
                  >-${{ descuento().toLocaleString("es-MX") }}</span
                >
              </div>
              } @if (metodoPago() === 'tarjeta' && montoComisionTerminal() > 0)
              {
              <div class="flex justify-between text-base text-orange-600">
                <span>Comisi√≥n Terminal ({{ comisionTerminal() }}%):</span>
                <span class="font-semibold"
                  >+${{ montoComisionTerminal().toLocaleString("es-MX") }}</span
                >
              </div>
              }

              <div
                class="border-t-2 border-gray-300 pt-3 flex justify-between items-center"
              >
                <span class="text-2xl font-bold text-gray-800"
                  >TOTAL A PAGAR:</span
                >
                <span class="text-3xl font-black text-green-600">
                  ${{ totalFinal().toLocaleString("es-MX") }}
                </span>
              </div>

              @if (metodoPago() === 'fiado' && clienteSeleccionado()) {
              <div
                class="flex justify-between text-sm text-blue-600 bg-blue-50 p-3 rounded-lg"
              >
                <span>Nuevo saldo del cliente:</span>
                <span class="font-bold">
                  ${{
                    (
                      clienteSeleccionado()!.saldoActual + totalFinal()
                    ).toLocaleString("es-MX")
                  }}
                </span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- ============================= -->
        <!-- FOOTER DEL MODAL (BOTONES) -->
        <!-- ============================= -->
        <div
          class="flex items-center justify-between gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl"
        >
          <button
            (click)="cerrarModalVenta()"
            class="flex-1 px-6 py-3 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg transition-colors"
            [disabled]="loading()"
          >
            Cancelar
          </button>

          <button
            (click)="confirmarVenta()"
            [disabled]="!puedeFinalizarVenta() || loading()"
            class="flex-1 px-6 py-4 bg-linear-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            @if (loading()) {
            <svg
              class="animate-spin h-5 w-5 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span>Procesando...</span>
            } @else {
            <span class="text-xl">üí∞</span>
            <span>COBRAR ${{ totalFinal().toLocaleString("es-MX") }}</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
