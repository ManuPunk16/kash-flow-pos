<div
  class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fadeIn overflow-y-auto"
  (click)="cerrar()"
>
  <div
    class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col animate-slideUp my-8"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <header
      class="bg-linear-to-r from-blue-600 to-blue-700 text-white px-6 py-5 shrink-0"
    >
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h2 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
            <span>üè¢</span>
            <span>{{ proveedor().nombre }}</span>
          </h2>
          @if (proveedor().empresa) {
          <p class="text-blue-100 text-sm md:text-base mt-2">
            üè≠ {{ proveedor().empresa }}
          </p>
          }
        </div>
        <button
          (click)="cerrar()"
          class="text-white/80 hover:text-white text-3xl leading-none transition-colors ml-4"
          type="button"
          aria-label="Cerrar"
        >
          ‚úï
        </button>
      </div>

      <!-- Info R√°pida -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-5">
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3">
          <p class="text-blue-100 text-xs mb-1">Saldo Pendiente</p>
          <p class="text-white text-xl font-bold">
            ${{ proveedor().saldoPendiente.toLocaleString('es-MX', {
            minimumFractionDigits: 2 }) }}
          </p>
        </div>
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3">
          <p class="text-blue-100 text-xs mb-1">Productos</p>
          <p class="text-white text-xl font-bold">
            {{ proveedor().productosCargados }}
          </p>
        </div>
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3">
          <p class="text-blue-100 text-xs mb-1">T√©rmino Pago</p>
          <p class="text-white text-xl font-bold">
            {{ proveedor().terminoPago }} d√≠as
          </p>
        </div>
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3">
          <p class="text-blue-100 text-xs mb-1">Estado</p>
          <p class="text-white text-xl font-bold">
            {{ proveedor().saldoPendiente > 0 ? '‚ö†Ô∏è Con Deuda' : '‚úÖ Al D√≠a' }}
          </p>
        </div>
      </div>
    </header>

    <!-- Tabs de Navegaci√≥n -->
    <nav class="bg-gray-100 border-b border-gray-200 px-6 shrink-0">
      <div class="flex gap-1 overflow-x-auto">
        <button
          type="button"
          (click)="cambiarTab('info')"
          [class.bg-white]="tabActiva() === 'info'"
          [class.text-blue-600]="tabActiva() === 'info'"
          [class.border-b-2]="tabActiva() === 'info'"
          [class.border-blue-600]="tabActiva() === 'info'"
          [class.text-gray-600]="tabActiva() !== 'info'"
          class="px-6 py-3 font-semibold transition-all hover:bg-white/50 whitespace-nowrap"
        >
          üìã Informaci√≥n
        </button>
        <button
          type="button"
          (click)="cambiarTab('productos')"
          [class.bg-white]="tabActiva() === 'productos'"
          [class.text-blue-600]="tabActiva() === 'productos'"
          [class.border-b-2]="tabActiva() === 'productos'"
          [class.border-blue-600]="tabActiva() === 'productos'"
          [class.text-gray-600]="tabActiva() !== 'productos'"
          class="px-6 py-3 font-semibold transition-all hover:bg-white/50 whitespace-nowrap"
        >
          üì¶ Productos ({{ totalProductos() }})
        </button>
        <button
          type="button"
          (click)="cambiarTab('pagos')"
          [class.bg-white]="tabActiva() === 'pagos'"
          [class.text-blue-600]="tabActiva() === 'pagos'"
          [class.border-b-2]="tabActiva() === 'pagos'"
          [class.border-blue-600]="tabActiva() === 'pagos'"
          [class.text-gray-600]="tabActiva() !== 'pagos'"
          class="px-6 py-3 font-semibold transition-all hover:bg-white/50 whitespace-nowrap"
        >
          üí∞ Historial de Pagos
        </button>
      </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
      <!-- TAB: Informaci√≥n -->
      @if (tabActiva() === 'info') {
      <div class="max-w-4xl mx-auto space-y-6">
        <!-- Datos de Contacto -->
        <section class="bg-white rounded-lg shadow-md p-6">
          <h3
            class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
          >
            <span>üìû</span>
            <span>Datos de Contacto</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @if (proveedor().contacto) {
            <div class="flex items-start gap-3">
              <span class="text-2xl">üë§</span>
              <div>
                <p class="text-sm text-gray-600">Persona de Contacto</p>
                <p class="text-base font-semibold text-gray-900">
                  {{ proveedor().contacto }}
                </p>
              </div>
            </div>
            } @if (proveedor().telefono) {
            <div class="flex items-start gap-3">
              <span class="text-2xl">üìû</span>
              <div>
                <p class="text-sm text-gray-600">Tel√©fono</p>
                <p class="text-base font-semibold text-gray-900">
                  {{ proveedor().telefono }}
                </p>
              </div>
            </div>
            } @if (proveedor().email) {
            <div class="flex items-start gap-3">
              <span class="text-2xl">üìß</span>
              <div>
                <p class="text-sm text-gray-600">Email</p>
                <p class="text-base font-semibold text-gray-900">
                  {{ proveedor().email }}
                </p>
              </div>
            </div>
            } @if (proveedor().nit) {
            <div class="flex items-start gap-3">
              <span class="text-2xl">üÜî</span>
              <div>
                <p class="text-sm text-gray-600">NIT / RFC</p>
                <p class="text-base font-semibold text-gray-900">
                  {{ proveedor().nit }}
                </p>
              </div>
            </div>
            }
          </div>
          @if (proveedor().direccion) {
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-start gap-3">
              <span class="text-2xl">üìç</span>
              <div>
                <p class="text-sm text-gray-600">Direcci√≥n</p>
                <p class="text-base font-semibold text-gray-900">
                  {{ proveedor().direccion }}
                </p>
              </div>
            </div>
          </div>
          }
        </section>

        <!-- Categor√≠as -->
        @if (proveedor().categorias && proveedor().categorias.length > 0) {
        <section class="bg-white rounded-lg shadow-md p-6">
          <h3
            class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
          >
            <span>üè∑Ô∏è</span>
            <span>Categor√≠as</span>
          </h3>
          <div class="flex flex-wrap gap-2">
            @for (categoria of proveedor().categorias; track categoria) {
            <span
              [class]="'px-4 py-2 rounded-full font-semibold text-sm ' + coloresCategorias[categoria]"
            >
              {{ etiquetasCategorias[categoria] }}
            </span>
            }
          </div>
        </section>
        }

        <!-- Informaci√≥n Financiera -->
        <section class="bg-white rounded-lg shadow-md p-6">
          <h3
            class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
          >
            <span>üí∞</span>
            <span>Informaci√≥n Financiera</span>
          </h3>
          <div class="space-y-4">
            <div
              class="flex items-center justify-between p-4 bg-red-50 rounded-lg border-l-4 border-red-500"
            >
              <div>
                <p class="text-sm text-red-700 font-medium">Saldo Pendiente</p>
                <p class="text-3xl font-bold text-red-600 mt-1">
                  ${{ proveedor().saldoPendiente.toLocaleString('es-MX', {
                  minimumFractionDigits: 2 }) }}
                </p>
              </div>
              @if (proveedor().saldoPendiente > 0) {
              <button
                (click)="abrirModalPago()"
                class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors flex items-center gap-2"
              >
                <span>üíµ</span>
                <span>Registrar Pago</span>
              </button>
              }
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <p class="text-sm text-blue-700 font-medium">T√©rmino de Pago</p>
                <p class="text-2xl font-bold text-blue-600 mt-1">
                  {{ proveedor().terminoPago }} d√≠as
                </p>
              </div>
              @if (proveedor().fechaUltimoAbono) {
              <div
                class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500"
              >
                <p class="text-sm text-green-700 font-medium">√öltimo Abono</p>
                <p class="text-2xl font-bold text-green-600 mt-1">
                  {{ proveedor().fechaUltimoAbono | date: 'dd/MM/yyyy' }}
                </p>
              </div>
              }
            </div>
          </div>
        </section>

        <!-- Fechas -->
        <section class="bg-white rounded-lg shadow-md p-6">
          <h3
            class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
          >
            <span>üìÖ</span>
            <span>Registro</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Fecha de Creaci√≥n</p>
              <p class="text-base font-semibold text-gray-900">
                {{ proveedor().fechaCreacion | date: 'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-600">√öltima Actualizaci√≥n</p>
              <p class="text-base font-semibold text-gray-900">
                {{ proveedor().fechaActualizacion | date: 'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
          </div>
        </section>
      </div>
      }

      <!-- TAB: Productos -->
      @if (tabActiva() === 'productos') {
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- M√©tricas de Productos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div
            class="bg-white rounded-lg shadow-md p-5 border-l-4 border-blue-500"
          >
            <p class="text-gray-600 text-sm font-medium">Total Productos</p>
            <p class="text-3xl font-bold text-blue-600 mt-1">
              {{ totalProductos() }}
            </p>
          </div>
          <div
            class="bg-white rounded-lg shadow-md p-5 border-l-4 border-green-500"
          >
            <p class="text-gray-600 text-sm font-medium">Valor Inventario</p>
            <p class="text-3xl font-bold text-green-600 mt-1">
              ${{ valorInventario().toLocaleString('es-MX', {
              minimumFractionDigits: 2 }) }}
            </p>
          </div>
          <div
            class="bg-white rounded-lg shadow-md p-5 border-l-4 border-yellow-500"
          >
            <p class="text-gray-600 text-sm font-medium">Bajo Stock</p>
            <p class="text-3xl font-bold text-yellow-600 mt-1">
              {{ productosBajoStock() }}
            </p>
          </div>
        </div>

        <!-- Barra de B√∫squeda -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="relative">
            <input
              type="text"
              placeholder="Buscar producto por nombre, c√≥digo de barras o categor√≠a..."
              [(ngModel)]="busquedaProducto"
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <span class="absolute left-3 top-3.5 text-gray-400 text-xl"
              >üîç</span
            >
          </div>
        </div>

        <!-- Estado de Carga -->
        @if (cargandoProductos()) {
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
          <div class="animate-spin text-6xl mb-4">‚è≥</div>
          <p class="text-gray-600 font-medium">Cargando productos...</p>
        </div>
        }

        <!-- Error -->
        @else if (errorProductos()) {
        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
          <div class="flex items-start gap-3">
            <span class="text-3xl">‚ùå</span>
            <div>
              <h4 class="font-bold text-red-800 mb-1">
                Error al cargar productos
              </h4>
              <p class="text-red-600">{{ errorProductos() }}</p>
              <button
                (click)="cargarProductos()"
                class="mt-3 bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors"
              >
                Reintentar
              </button>
            </div>
          </div>
        </div>
        }

        <!-- Lista de Productos -->
        @else if (productosFiltrados().length === 0) {
        <div
          class="bg-yellow-50 border-l-4 border-yellow-500 p-8 rounded-lg text-center"
        >
          <span class="text-6xl block mb-4">üì≠</span>
          <h4 class="text-lg font-bold text-yellow-800 mb-2">Sin productos</h4>
          <p class="text-yellow-700">
            @if (busquedaProducto()) { No se encontraron productos con "{{
            busquedaProducto() }}" } @else { Este proveedor no tiene productos
            asignados }
          </p>
        </div>
        } @else {
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-100 border-b-2 border-gray-200">
                <tr>
                  <th
                    class="px-6 py-4 text-left text-sm font-bold text-gray-700"
                  >
                    Producto
                  </th>
                  <th
                    class="px-6 py-4 text-left text-sm font-bold text-gray-700"
                  >
                    Categor√≠a
                  </th>
                  <th
                    class="px-6 py-4 text-center text-sm font-bold text-gray-700"
                  >
                    Stock
                  </th>
                  <th
                    class="px-6 py-4 text-right text-sm font-bold text-gray-700"
                  >
                    Costo
                  </th>
                  <th
                    class="px-6 py-4 text-right text-sm font-bold text-gray-700"
                  >
                    Precio Venta
                  </th>
                  <th
                    class="px-6 py-4 text-center text-sm font-bold text-gray-700"
                  >
                    M√©tricas (30d)
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                @for (producto of productosFiltrados(); track producto._id) {
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4">
                    <div>
                      <p class="font-semibold text-gray-900">
                        {{ producto.nombre }}
                      </p>
                      @if (producto.codigoBarras) {
                      <p class="text-sm text-gray-600">
                        {{ producto.codigoBarras }}
                      </p>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <span
                      class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold capitalize"
                    >
                      {{ producto.categoria }}
                    </span>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <span
                      [class]="'font-bold text-lg ' + obtenerColorStock(producto)"
                    >
                      {{ producto.stock }}
                    </span>
                  </td>
                  <td class="px-6 py-4 text-right font-semibold text-gray-900">
                    ${{ producto.costoUnitario.toLocaleString('es-MX', {
                    minimumFractionDigits: 2 }) }}
                  </td>
                  <td class="px-6 py-4 text-right font-semibold text-green-600">
                    ${{ producto.precioVenta.toLocaleString('es-MX', {
                    minimumFractionDigits: 2 }) }}
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-center gap-4">
                      <div class="text-center">
                        <p class="text-xs text-gray-600">Vendido</p>
                        <p class="text-sm font-bold text-blue-600">
                          {{ producto.metricas.cantidadVendida }}
                        </p>
                      </div>
                      <div class="text-center">
                        <p class="text-xs text-gray-600">Rotaci√≥n</p>
                        <p
                          class="text-sm font-bold text-gray-900 flex items-center gap-1"
                        >
                          {{ obtenerIconoRotacion(producto.metricas.rotacion) }}
                          {{ producto.metricas.rotacion.toFixed(2) }}
                        </p>
                      </div>
                      <div class="text-center">
                        <p class="text-xs text-gray-600">Margen</p>
                        <p class="text-sm font-bold text-green-600">
                          {{ producto.metricas.margenGanancia }}%
                        </p>
                      </div>
                    </div>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
        }
      </div>
      }

      <!-- TAB: Historial de Pagos -->
      @if (tabActiva() === 'pagos') {
      <div class="max-w-5xl mx-auto">
        <app-historial-pagos [proveedorId]="proveedor()._id" />
      </div>
      }
    </main>
  </div>
</div>

<!-- Modal de Pago -->
@if (mostrarModalPago()) {
<app-modal-pago-proveedor
  [proveedor]="proveedor()"
  (onCerrar)="cerrarModalPago()"
  (onPagoExitoso)="alPagoExitoso()"
/>
}
